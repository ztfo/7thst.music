#!/usr/bin/env node

/**
 * Script to fetch images from Cloudinary based on tags
 * Run: node fetch-cloudinary-images.js
 * 
 * This will generate a images-data.js file that can be included in art.html
 */

require('dotenv').config();
const cloudinary = require('cloudinary').v2;
const fs = require('fs');
const path = require('path');

// Configure Cloudinary
const cloudName = process.env.CLOUDINARY_CLOUD_NAME;
const apiKey = process.env.CLOUDINARY_API_KEY;
const apiSecret = process.env.CLOUDINARY_API_SECRET;

if (!cloudName || !apiKey || !apiSecret) {
  console.error('âŒ Error: Missing Cloudinary credentials in .env file');
  console.error('Required: CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET');
  process.exit(1);
}

cloudinary.config({
  cloud_name: cloudName,
  api_key: apiKey,
  api_secret: apiSecret
});

console.log(`âœ“ Connected to Cloudinary: ${cloudName}\n`);

// Categories and their corresponding tags (using exact tag names from Cloudinary)
const categories = {
  dreams: 'Dreams',
  mandalas: 'Mandala', // Note: tag is "Mandala" (singular) in Cloudinary
  voices: 'Voices',
  animals: 'Animals',
  songart: 'Song Art' // Note: tag has a space
};

// Layout types (portrait = 2 columns, square = square grid)
const layouts = {
  dreams: 'square',
  mandalas: 'square',
  voices: 'portrait',
  animals: 'portrait',
  songart: 'square'
};

async function fetchImagesByTag(tag) {
  try {
    console.log(`Fetching images with tag: ${tag}...`);
    
    // Use Admin API to get all resources with tags, then filter
    const result = await cloudinary.api.resources({
      type: 'upload',
      resource_type: 'image',
      max_results: 500,
      tags: true
    });

    if (!result || !result.resources) {
      console.log(`  No resources found`);
      return [];
    }

    // Filter images by tag
    const taggedImages = result.resources.filter(img => {
      if (!img.tags || !Array.isArray(img.tags)) return false;
      return img.tags.includes(tag);
    });

    if (taggedImages.length === 0) {
      console.log(`  No images found with tag: ${tag}`);
      return [];
    }

    console.log(`  âœ“ Found ${taggedImages.length} images with tag: ${tag}`);

    // Sort by created_at (newest first)
    taggedImages.sort((a, b) => {
      const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
      const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
      return dateB - dateA;
    });

    return taggedImages.map(img => {
      // Generate optimized URLs
      const thumbnailUrl = cloudinary.url(img.public_id, {
        transformation: [
          { quality: 'auto', fetch_format: 'auto' },
          { width: 800, crop: 'limit' }
        ]
      });

      const lightboxUrl = cloudinary.url(img.public_id, {
        transformation: [
          { quality: 'auto', fetch_format: 'auto' },
          { width: 2000, crop: 'limit' }
        ]
      });

      return {
        url: thumbnailUrl,
        lightboxUrl: lightboxUrl,
        alt: img.public_id.split('/').pop().replace(/_/g, ' ').replace(/-/g, ' ') || `Image ${img.public_id}`
      };
    });
  } catch (error) {
    console.error(`  âŒ Error fetching images for tag "${tag}":`, error.message || error);
    if (error.http_code) {
      console.error(`  HTTP Code: ${error.http_code}`);
    }
    return [];
  }
}

async function main() {
  console.log('Starting Cloudinary image fetch...\n');

  const images = {};

  // Fetch images for each category
  for (const [category, tag] of Object.entries(categories)) {
    const categoryImages = await fetchImagesByTag(tag);
    images[category] = categoryImages;
    console.log(`Found ${categoryImages.length} images for ${category}\n`);
  }

  // Generate JavaScript file
  const jsContent = `// Auto-generated by fetch-cloudinary-images.js
// Run: node fetch-cloudinary-images.js to update
// Last updated: ${new Date().toISOString()}

// Assign to window.images for global access
window.images = ${JSON.stringify(images, null, 2)};
`;

  // Write to file (output to root directory for GitHub Pages)
  const outputPath = path.join(__dirname, '..', 'images-data.js');
  fs.writeFileSync(outputPath, jsContent, 'utf8');

  console.log(`\nâœ… Success! Generated ${outputPath}`);
  console.log(`\nTotal images by category:`);
  Object.entries(images).forEach(([category, imgs]) => {
    console.log(`  ${category}: ${imgs.length} images`);
  });
  console.log(`\nğŸ“ Next step: Update art.html to include images-data.js`);
}

main().catch(console.error);

