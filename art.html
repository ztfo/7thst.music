<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Art - 7thSt.music</title>
    
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <!-- <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#000000"> -->
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#000000">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G9DRK12SZE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-G9DRK12SZE');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: #000;
            color: #FFF;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .header {
            padding: 2rem 1rem;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.5));
        }

        .back-link {
            color: rgba(231, 212, 148, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 0 auto;
            margin-top: 2rem;
            text-align: center;
            width: 100%;
        }

        .back-link:hover {
            color: #E7D494;
            text-shadow: 0 0 10px rgba(231, 212, 148, 0.3);
        }

        .art-gallery {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .tab-button {
            background: transparent;
            border: 1px solid rgba(231, 212, 148, 0.15);
            color: rgba(231, 212, 148, 0.6);
            padding: 0.8rem 2rem;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: lowercase;
        }

        .tab-button:hover {
            border-color: rgba(231, 212, 148, 0.3);
            color: rgba(231, 212, 148, 0.9);
        }

        .tab-button.active {
            background: rgba(231, 212, 148, 0.1);
            border-color: rgba(231, 212, 148, 0.4);
            color: #E7D494;
        }

        .tab-description {
            text-align: center;
            color: rgba(231, 212, 148, 0.6);
            font-size: 0.9rem;
            font-style: italic;
            margin: -1.5rem 0 2rem;
            padding: 0 1rem;
            min-height: 1.5rem;
            transition: opacity 0.3s ease;
        }

        .gallery-section {
            display: none;
        }

        .gallery-section.active {
            display: block;
        }

        /* 2-column portrait grid for Animals */
        .gallery-grid.portrait {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            padding: 1rem 0;
        }

        /* Square grid for Mandalas and Dreams */
        .gallery-grid.square {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            padding: 1rem 0;
        }

        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Skeleton loader */
        .skeleton-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(231, 212, 148, 0.05) 0%,
                rgba(231, 212, 148, 0.1) 50%,
                rgba(231, 212, 148, 0.05) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            z-index: 1;
        }

        .gallery-item img.loaded {
            opacity: 1;
        }

        .gallery-item img {
            opacity: 0;
            transition: opacity 0.4s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }

        /* Copyright watermark on images */
        .gallery-item::before {
            content: '© 2025 Luis Palomares - 7thSt.Music';
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: rgba(0, 0, 0, 0.6);
            font-size: 0.65rem;
            font-family: 'Inter', sans-serif;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .gallery-item:hover::before {
            opacity: 1;
        }

        /* Title box at top of lightbox (for mandalas) */
        .lightbox-title {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 0, 0, 0.6);
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            pointer-events: none;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.7);
            padding: 6px 12px;
            border-radius: 4px;
            display: none;
        }

        .lightbox-title.has-content {
            display: block;
        }

        .lightbox-content.has-loaded-image .lightbox-title.has-content {
            opacity: 1;
        }

        /* Watermark on lightbox image - only show when image is loaded */
        .lightbox-content::after {
            content: '© 2025 Luis Palomares - 7thSt.Music';
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 0, 0, 0.6);
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            pointer-events: none;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.7);
            padding: 6px 12px;
            border-radius: 4px;
        }

        .lightbox-content.has-loaded-image::after {
            opacity: 1;
        }

        .gallery-item .skeleton-loader.hidden {
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .gallery-item.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .gallery-item.portrait {
            aspect-ratio: auto;
        }

        .gallery-item.square {
            aspect-ratio: 1;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(231, 212, 148, 0);
            transition: background 0.3s ease;
            pointer-events: none;
        }

        .gallery-item:hover::after {
            background: rgba(231, 212, 148, 0.05);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            cursor: default;
        }

        .lightbox-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: linear-gradient(
                90deg,
                rgba(231, 212, 148, 0.05) 0%,
                rgba(231, 212, 148, 0.1) 50%,
                rgba(231, 212, 148, 0.05) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
            z-index: 1;
        }

        .lightbox-skeleton.hidden {
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            display: block;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.4s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
        }

        .lightbox-content img.loaded {
            opacity: 1;
        }

        .lightbox-close {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: transparent;
            border: 1px solid rgba(231, 212, 148, 0.3);
            color: rgba(231, 212, 148, 0.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            z-index: 1001;
        }

        .lightbox-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: 1px solid rgba(231, 212, 148, 0.3);
            color: rgba(231, 212, 148, 0.8);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            z-index: 1001;
        }

        .lightbox-nav:hover {
            background: rgba(231, 212, 148, 0.1);
            border-color: rgba(231, 212, 148, 0.5);
            color: #E7D494;
        }

        .lightbox-nav.prev {
            left: 2rem;
        }

        .lightbox-nav.next {
            right: 2rem;
        }

        .lightbox-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .lightbox-close:hover {
            background: rgba(231, 212, 148, 0.1);
            border-color: rgba(231, 212, 148, 0.5);
            color: #E7D494;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gallery-grid.portrait {
                grid-template-columns: 1fr;
            }

            .gallery-grid.square {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }

            .tab-nav {
                gap: 1rem;
            }

            .tab-button {
                padding: 0.6rem 1.5rem;
                font-size: 0.85rem;
            }

            .art-gallery {
                padding: 1rem;
            }

            .lightbox-close {
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                font-size: 1.3rem;
            }

            .lightbox-nav {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }

            .lightbox-nav.prev {
                left: 1rem;
            }

            .lightbox-nav.next {
                right: 1rem;
            }
        }

        @media (max-width: 480px) {
            .gallery-grid.square {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="back-link">
        <a href="index.html" class="back-link">&larr; Back to Music</a>
    </div>
    <div class="header">
        <img src="assets/squaresnake.svg" alt="logo" class="logo">
    </div>

    <div class="art-gallery">
        <div class="tab-nav">
            <button class="tab-button active" data-tab="dreams">Dreams</button>
            <button class="tab-button" data-tab="mandalas">Mandalas</button>
            <button class="tab-button" data-tab="voices">Voices</button>
            <button class="tab-button" data-tab="animals">Animals</button>
            <button class="tab-button" data-tab="songart">Song Art</button>
        </div>

        <div class="tab-description" id="tab-description">random illustrations of emotions, dreams, memories,  or just random play</div>

        <!-- Dreams Gallery (Square) -->
        <div class="gallery-section active" id="dreams-gallery">
            <div class="gallery-grid square" id="dreams-grid">
            </div>
        </div>

        <!-- Mandalas Gallery (Square) -->
        <div class="gallery-section" id="mandalas-gallery">
            <div class="gallery-grid square" id="mandalas-grid">
            </div>
        </div>

        <!-- Voices Gallery (Portrait) -->
        <div class="gallery-section" id="voices-gallery">
            <div class="gallery-grid portrait" id="voices-grid">
            </div>
        </div>

        <!-- Animals Gallery (Portrait) -->
        <div class="gallery-section" id="animals-gallery">
            <div class="gallery-grid portrait" id="animals-grid">
            </div>
        </div>

        <!-- Song Art Gallery (Square) -->
        <div class="gallery-section" id="songart-gallery">
            <div class="gallery-grid square" id="songart-grid">
            </div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close">&times;</button>
        <button class="lightbox-nav prev" id="lightbox-prev" aria-label="Previous image">‹</button>
        <button class="lightbox-nav next" id="lightbox-next" aria-label="Next image">›</button>
        <div class="lightbox-content">
            <div class="lightbox-title" id="lightbox-title"></div>
            <div class="lightbox-skeleton" id="lightbox-skeleton"></div>
            <img id="lightbox-image" src="" alt="">
        </div>
    </div>

    <!-- Copyright Footer -->
    <section class="copyright" style="text-align: center; padding: 3rem 1rem 2rem; color: rgba(231, 212, 148, 0.4); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px;">
        <small>
            &copy; 2025 - Luis Palomares - 7thSt.Music - All rights reserved.
        </small>
    </section>

    <!-- Load Cloudinary images data (generated by fetch-cloudinary-images.js) -->
    <script src="images-data.js"></script>
    
    <script>
        // Image data will be loaded from images-data.js
        // If images-data.js doesn't exist or fails to load, use empty structure
        if (typeof window.images === 'undefined') {
            window.images = {
                dreams: [],
                mandalas: [],
                voices: [],
                animals: [],
                songart: []
            };
        }
        
        // Create a local reference for easier access
        const images = window.images;

        // Tab descriptions
        const tabDescriptions = {
            dreams: 'random illustrations of emotions, dreams, or just random play',
            mandalas: 'patterns I doodle to decompress, while making or listening to music',
            voices: 'words that stick to me',
            animals: 'my favorite pieces to draw',
            songart: 'illustrations for my music'
        };

        // Tab navigation
        const tabButtons = document.querySelectorAll('.tab-button');
        const gallerySections = document.querySelectorAll('.gallery-section');
        const tabDescription = document.getElementById('tab-description');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');

                // Track tab click
                gtag('event', 'click', {
                    'event_category': 'Art Gallery Tab',
                    'event_label': targetTab.charAt(0).toUpperCase() + targetTab.slice(1),
                    'transport_type': 'beacon'
                });

                // Update active tab
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Update description
                if (tabDescriptions[targetTab]) {
                    tabDescription.textContent = tabDescriptions[targetTab];
                }

                // Show/hide galleries
                gallerySections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${targetTab}-gallery`).classList.add('active');

                // Trigger scroll animations for newly visible gallery
                setTimeout(() => {
                    observeGallery(`${targetTab}-grid`);
                }, 100);
            });
        });

        // Layout configuration (portrait = 2 columns, square = square grid)
        const layouts = {
            dreams: 'square',
            mandalas: 'square',
            voices: 'portrait',
            animals: 'portrait',
            songart: 'square'
        };

        // Shuffle array function (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy to avoid mutating original
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render gallery images
        function renderGallery(category, gridId) {
            const grid = document.getElementById(gridId);
            const categoryImages = images[category];
            
            if (!categoryImages || categoryImages.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: rgba(231, 212, 148, 0.5); padding: 3rem;">No images found. Run: node fetch-cloudinary-images.js</p>';
                return;
            }

            grid.innerHTML = '';
            const isPortrait = layouts[category] === 'portrait';

            // Shuffle images for random order each time
            const shuffledImages = shuffleArray(categoryImages);

            shuffledImages.forEach((imageData, index) => {
                const item = document.createElement('div');
                item.className = `gallery-item ${isPortrait ? 'portrait' : 'square'}`;
                
                // Create skeleton loader
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-loader';
                item.appendChild(skeleton);
                
                const img = document.createElement('img');
                img.alt = imageData.alt || `Image ${index + 1}`;
                img.loading = 'lazy';
                
                // Add staggered delay for loading
                const loadDelay = index * 50; // 50ms delay between each image
                
                setTimeout(() => {
                    img.src = imageData.url;
                }, loadDelay);
                
                // Handle image load
                img.addEventListener('load', () => {
                    img.classList.add('loaded');
                    skeleton.classList.add('hidden');
                    // Remove skeleton after fade out
                    setTimeout(() => {
                        if (skeleton.parentNode) {
                            skeleton.remove();
                        }
                    }, 300);
                });
                
                img.addEventListener('error', () => {
                    skeleton.classList.add('hidden');
                    img.style.display = 'none';
                    item.innerHTML = '<div style="padding: 2rem; text-align: center; color: rgba(231, 212, 148, 0.3);">Image failed to load</div>';
                });

                item.appendChild(img);
                // Use lightboxUrl if available, otherwise fall back to url
                const lightboxUrl = imageData.lightboxUrl || imageData.url;
                // Store category and index for navigation
                item.setAttribute('data-category', category);
                item.setAttribute('data-index', index);
                item.addEventListener('click', () => {
                    // Track image click
                    gtag('event', 'click', {
                        'event_category': 'Art Gallery Image',
                        'event_label': `${category.charAt(0).toUpperCase() + category.slice(1)} - Image ${index + 1}`,
                        'transport_type': 'beacon'
                    });
                    openLightbox(category, index, shuffledImages);
                });
                
                grid.appendChild(item);
            });

            // Observe for scroll animations
            observeGallery(gridId);
        }

        // Intersection Observer for scroll animations
        function observeGallery(gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return;

            const items = grid.querySelectorAll('.gallery-item:not(.fade-in)');
            
            if (items.length === 0) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            entry.target.classList.add('fade-in');
                            observer.unobserve(entry.target);
                        }, index * 50); // Staggered delay
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            items.forEach(item => observer.observe(item));
        }

        // Lightbox functionality
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxContent = document.querySelector('.lightbox-content');
        const lightboxSkeleton = document.getElementById('lightbox-skeleton');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxClose = document.getElementById('lightbox-close');
        const lightboxPrev = document.getElementById('lightbox-prev');
        const lightboxNext = document.getElementById('lightbox-next');

        // Track current lightbox state
        let currentCategory = null;
        let currentIndex = -1;
        let currentImages = [];

        // Extract mandala name from displayName, filename, or alt text
        function extractMandalaName(imageData) {
            if (currentCategory !== 'mandalas') return null;
            
            let name = null;
            
            // First priority: use displayName if available (what user sees when hovering in Cloudinary)
            if (imageData.displayName) {
                // displayName might be "Earthly_Resonance_hash" or "Earthly Resonance"
                // Extract name before the last underscore if it contains underscores
                const displayParts = imageData.displayName.split('_');
                if (displayParts.length >= 2) {
                    // Take all parts except the last one (the hash)
                    const nameParts = displayParts.slice(0, -1);
                    name = nameParts.join(' ');
                } else {
                    // No underscores, might already be formatted
                    name = imageData.displayName;
                }
            }
            
            // Second priority: extract from filename/publicId
            if (!name) {
                const publicId = imageData.publicId || '';
                const url = imageData.lightboxUrl || imageData.url;
                
                // Extract filename from publicId (last part after slash) or from URL
                let filename = '';
                if (publicId) {
                    filename = publicId.split('/').pop();
                } else {
                    // Fallback: extract from URL (last part before query params)
                    const urlPath = url.split('?')[0].split('/');
                    filename = urlPath[urlPath.length - 1];
                }
                
                // Extract name before the last underscore (which contains the hash)
                // Pattern: "Earthly_Resonance_hash" -> "Earthly Resonance"
                const parts = filename.split('_');
                
                if (parts.length >= 2) {
                    // Take all parts except the last one (the hash)
                    const nameParts = parts.slice(0, -1);
                    name = nameParts.join(' ');
                }
            }
            
            // Third priority: check if alt text has a meaningful name
            if (!name) {
                const altText = imageData.alt || '';
                
                // Check if alt text looks like a name (has capital letters, spaces, etc.)
                // and is not just a hash (long alphanumeric string without spaces)
                if (altText && altText.length < 50) {
                    // If it has capital letters and spaces, it might be a name
                    if (/[A-Z]/.test(altText) && /\s/.test(altText)) {
                        // Remove hash-like suffix if present (alphanumeric at the end after space)
                        name = altText.replace(/\s+[a-z0-9]{6,}$/i, '').trim();
                        // If what's left is too short or looks like a hash, use full alt
                        if (name.length < 3 || /^[a-z0-9]+$/i.test(name)) {
                            name = altText.trim();
                        }
                    } else if (altText.length > 3 && altText.length < 20 && /[A-Z]/.test(altText)) {
                        // Single word with capital letter might be a name
                        name = altText.trim();
                    }
                }
            }
            
            // Clean up: remove any weird characters, multiple spaces, etc.
            if (name) {
                name = name.replace(/[^a-zA-Z0-9\s]/g, ''); // Remove special characters
                name = name.replace(/\s+/g, ' ').trim(); // Normalize spaces
                // Don't show if it's just a hash (long alphanumeric without spaces)
                if (/^[a-z0-9]{15,}$/i.test(name)) {
                    name = null;
                }
            }
            
            return name || null;
        }

        function loadLightboxImage(imageData) {
            // Reset state
            lightboxImage.classList.remove('loaded');
            lightboxImage.src = '';
            lightboxImage.alt = imageData.alt || '';
            lightboxSkeleton.classList.remove('hidden');
            lightboxContent.classList.remove('has-loaded-image'); // Hide watermark initially
            
            // Handle mandala title
            const mandalaName = extractMandalaName(imageData);
            if (mandalaName && currentCategory === 'mandalas') {
                lightboxTitle.textContent = mandalaName;
                lightboxTitle.classList.add('has-content');
            } else {
                lightboxTitle.textContent = '';
                lightboxTitle.classList.remove('has-content');
            }
            
            // Load image
            const imageUrl = imageData.lightboxUrl || imageData.url;
            lightboxImage.src = imageUrl;
            
            // Handle image load
            lightboxImage.addEventListener('load', function onLoad() {
                lightboxImage.classList.add('loaded');
                lightboxSkeleton.classList.add('hidden');
                // Show watermark and title when image is loaded
                lightboxContent.classList.add('has-loaded-image');
                if (mandalaName && currentCategory === 'mandalas') {
                    lightboxTitle.style.opacity = '1';
                }
                // Remove listener after first load
                lightboxImage.removeEventListener('load', onLoad);
            }, { once: true });
        }

        function updateNavigationButtons() {
            if (currentImages.length === 0) {
                lightboxPrev.disabled = true;
                lightboxNext.disabled = true;
                return;
            }

            lightboxPrev.disabled = currentIndex === 0;
            lightboxNext.disabled = currentIndex === currentImages.length - 1;
        }

        function openLightbox(category, index, images) {
            currentCategory = category;
            currentIndex = index;
            currentImages = images;
            
            // Show lightbox
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Load first image
            loadLightboxImage(currentImages[currentIndex]);
            updateNavigationButtons();
        }

        function navigateLightbox(direction) {
            if (currentImages.length === 0) return;
            
            // Track lightbox navigation
            gtag('event', 'click', {
                'event_category': 'Lightbox Navigation',
                'event_label': direction === 'next' ? 'Next Image' : 'Previous Image',
                'transport_type': 'beacon'
            });
            
            const newIndex = direction === 'next' 
                ? currentIndex + 1 
                : currentIndex - 1;
            
            if (newIndex < 0 || newIndex >= currentImages.length) return;
            
            currentIndex = newIndex;
            loadLightboxImage(currentImages[currentIndex]);
            updateNavigationButtons();
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
            setTimeout(() => {
                lightboxImage.src = '';
                lightboxImage.classList.remove('loaded');
                lightboxSkeleton.classList.remove('hidden');
                lightboxContent.classList.remove('has-loaded-image');
                lightboxTitle.textContent = '';
                lightboxTitle.classList.remove('has-content');
                lightboxTitle.style.opacity = '0';
                // Reset navigation state
                currentCategory = null;
                currentIndex = -1;
                currentImages = [];
            }, 300);
        }

        lightboxClose.addEventListener('click', (e) => {
            e.stopPropagation();
            closeLightbox();
        });

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        // Navigation button handlers
        lightboxPrev.addEventListener('click', (e) => {
            e.stopPropagation();
            navigateLightbox('prev');
        });

        lightboxNext.addEventListener('click', (e) => {
            e.stopPropagation();
            navigateLightbox('next');
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigateLightbox('prev');
            } else if (e.key === 'ArrowRight') {
                navigateLightbox('next');
            }
        });

        // Initialize galleries
        function initGalleries() {
            renderGallery('dreams', 'dreams-grid');
            renderGallery('mandalas', 'mandalas-grid');
            renderGallery('voices', 'voices-grid');
            renderGallery('animals', 'animals-grid');
            renderGallery('songart', 'songart-grid');
        }

        // Prevent right-click and image saving
        document.addEventListener('contextmenu', (e) => {
            // Allow right-click on non-image elements
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        // Prevent drag and drop
        document.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        // Prevent common keyboard shortcuts for saving
        document.addEventListener('keydown', (e) => {
            // Disable Save Image (Ctrl+S / Cmd+S on images)
            if ((e.ctrlKey || e.metaKey) && e.key === 's' && e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
            // Disable Save Image As (Ctrl+Shift+S / Cmd+Shift+S)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                return false;
            }
        });

        // Prevent image selection
        document.addEventListener('selectstart', (e) => {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        // Track back link click
        const backLink = document.querySelector('.back-link a');
        if (backLink) {
            backLink.addEventListener('click', function() {
                gtag('event', 'click', {
                    'event_category': 'Navigation',
                    'event_label': 'Back to Music',
                    'transport_type': 'beacon'
                });
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initGalleries();
        });
    </script>
</body>
</html>

